<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Proctoring Vanilla Demo</title>
    <!-- Import map to resolve @mediapipe/tasks-vision in the browser -->
    <script type="importmap">
    {
        "imports": {
            "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"
        }
    }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f3f4f6;
            padding: 40px;
            color: #1f2937;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: #9ca3af;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            background: #3b82f6;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .info-text {
            font-size: 14px;
            color: #6b7280;
        }

        #event-log {
            margin-top: 24px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        .event-item {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .event-type {
            font-weight: 600;
        }

        .event-time {
            color: #9ca3af;
            font-size: 12px;
        }

        .severity-high {
            border-left: 4px solid #ef4444;
            background: #fee2e2;
        }

        .severity-medium {
            border-left: 4px solid #f59e0b;
            background: #fef3c7;
        }

        .severity-low {
            border-left: 4px solid #10b981;
            background: #ecfdf5;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç AI Proctoring Demo</h1>
        <p>Vanilla JavaScript example. Ensure you are running this via a <strong>local server</strong> (e.g.,
            <code>npx serve .</code>).
        </p>

        <div class="video-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="status" class="status-badge">Initializing...</div>
        </div>

        <div class="controls">
            <button id="start-btn" disabled>Start Proctoring</button>
            <button id="stop-btn" disabled>Stop</button>
            <span id="init-info" class="info-text">Waiting for models...</span>
        </div>

        <h3>Latest Events</h3>
        <div id="event-log">
            <i>No events yet. Start proctoring to begin monitoring.</i>
        </div>
    </div>

    <script type="module">
        import {  ProctoringEngine } from '../src/index.js';

        console.log('Demo script loaded');

        const video = document.getElementById('webcam');
        const statusBadge = document.getElementById('status');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const eventLog = document.getElementById('event-log');
        const initInfo = document.getElementById('init-info');

        // Use the Singleton pattern to ensure only one engine instance exists
        const proctor = ProctoringEngine.getInstance({
            onEvent: (e) => {
                const div = document.createElement('div');
                const severity = e.lv >= 8 ? 'high' : e.lv >= 5 ? 'medium' : 'low';
                div.className = `event-item severity-${severity}`;
                div.innerHTML = `
                    <span class="event-type">${e.event} (Direction ${e.direction} (Duration ${e.duration})</span>
                    <span class="event-time">${new Date(e.ts).toLocaleTimeString()}</span>

                `;

                if (eventLog.firstChild && eventLog.firstChild.nodeName === 'I') {
                    eventLog.innerHTML = '';
                }
                eventLog.prepend(div);
                console.log("Visual State:", proctor.stateManager.getVisualState(), "Audio State:", proctor.stateManager.getAudioState(), "Session State:", proctor.stateManager.getSessionState(), "Complete State:", proctor.stateManager.getCompleteState(), "Event:", e, "Event Log:", eventLog.innerHTML.replace(/<\/?[^>]+(>|$)/g, "").split("\n").filter(l => l.trim()).slice(-10).join("\n"))
            },
            onStatusChange: (status) => {
                console.log('Engine Status:', status);
                statusBadge.innerText = status.toUpperCase();
                const colors = {
                    'ready': '#10b981',
                    'loading-models': '#3b82f6',
                    'error': '#ef4444',
                    'initializing': '#9ca3af'
                };
                statusBadge.style.background = colors[status] || '#9ca3af';

                if (status === 'ready') {
                    startBtn.disabled = false;
                    initInfo.innerText = 'Models ready (cached locally).';
                } else if (status === 'error') {
                    initInfo.innerText = 'Error loading models. Check console.';
                    initInfo.style.color = '#ef4444';
                }
            },
            onError: (err) => {
                console.error('Proctoring Engine Error:', err);
            }
        });

        // Setup button handlers BEFORE initialization
        startBtn.onclick = async () => {
            console.log('Start button clicked');
            try {
                initInfo.innerText = 'Requesting camera...';
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 }
                });
                console.log('Camera access granted');
                video.srcObject = stream;

                proctor.start(video);
                console.log('Engine started with video element');

                startBtn.disabled = true;
                stopBtn.disabled = false;
                initInfo.innerText = 'Monitoring active.';
            } catch (err) {
                console.error('Camera access error:', err);
                alert('Camera error: ' + err.message);
                initInfo.innerText = 'Camera access denied.';
            }
        };

        stopBtn.onclick = () => {
            console.log('Stop button clicked');
            proctor.stop();
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
            }
            startBtn.disabled = false;
            stopBtn.disabled = true;
            initInfo.innerText = 'Monitoring stopped.';
        };

        // Initialize engine
        console.log('Initializing engine...');
        proctor.initialize().catch(err => {
            console.error('Initialization failed:', err);
        });
    </script>
</body>

</html>